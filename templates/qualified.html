<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>pointslotto</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@600;700;800&display=swap">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            /* Background image provided by user: place as static/img/background.jpg */
            background-image: linear-gradient(rgba(20, 16, 48, 0.65), rgba(20, 16, 48, 0.65)), url('/static/img/background.jpg');
            background-size: cover;
            background-position: center 75%;
            background-repeat: no-repeat;
            background-attachment: fixed;
            min-height: 100vh;
            padding: 0;
            color: #333;
            position: relative;
            overflow-x: hidden;
        }
        
        /* Snow animation */
        .snow-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            overflow: hidden;
        }
        
        .snowflake {
            position: absolute;
            color: rgba(255, 255, 255, 0.3);
            font-size: 12px;
            font-family: Arial;
            text-shadow: 0 0 3px rgba(255, 255, 255, 0.2);
            animation: fall linear infinite;
            top: -20px;
        }
        
        @keyframes fall {
            0% {
                transform: translateY(0) translateX(0) rotate(0deg);
                opacity: 0.4;
            }
            100% {
                transform: translateY(100vh) translateX(30px) rotate(360deg);
                opacity: 0;
            }
        }
        
        /* Ensure content stays above snow */
        .header, .container {
            position: relative;
            z-index: 10;
        }
        
        /* Terminal-style outer frame */
        .terminal-frame {
            max-width: 1400px;
            margin: 24px auto;
            border-radius: 0;
            border: 1px solid rgba(255,255,255,0.4);
            box-shadow: 0 20px 60px rgba(0,0,0,0.2), inset 0 0 0 1px rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(15px);
            overflow: hidden;
            position: relative;
        }
        .terminal-topbar {
            height: 42px;
            background: rgba(0,0,0,0.1);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            padding: 0 14px;
            gap: 8px;
        }
        .term-dot { width: 12px; height: 12px; border-radius: 50%; }
        .term-dot.red { background: #ff5f57; box-shadow: 0 0 8px rgba(255,95,87,0.6); }
        .term-dot.yellow { background: #ffbd2e; box-shadow: 0 0 8px rgba(255,189,46,0.6); }
        .term-dot.green { background: #28c840; box-shadow: 0 0 8px rgba(40,200,64,0.6); }
        .terminal-inner { padding: 0; }

        /* Window states */
        .terminal-frame.fullscreen { max-width: 98vw; margin: 12px auto; border-width: 1px; }
        .terminal-frame.collapsed .terminal-inner { display: none; }
        .terminal-frame.collapsed { height: 42px; }
        .terminal-frame.hidden { display: none; }

        /* Brighter background when showcasing image */
        body.bg-bright {
            background-image: linear-gradient(rgba(20, 16, 48, 0.35), rgba(20, 16, 48, 0.35)), url('/static/img/background.jpg');
            background-position: center 75%;
        }

        /* Restore button when closed */
        #restoreWindowBtn {
            position: fixed;
            top: 16px;
            left: 16px;
            z-index: 1200;
            padding: 8px 12px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.18);
            background: rgba(0,0,0,0.45);
            color: #fff;
            font-size: 13px;
            cursor: pointer;
            display: none;
            backdrop-filter: blur(6px);
        }

        .header {
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(12px);
            padding: 10px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-family: 'Space Grotesk', 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 28px;
            font-weight: 800;
            color: #fff;
            letter-spacing: 0.8px;
            text-shadow: 0 2px 8px rgba(0,0,0,0.45), 0 0 22px rgba(220, 20, 60, 0.7);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .logo a {
            color: #fff;
            text-decoration: underline;
            transition: opacity 0.2s;
        }
        
        .logo a:hover {
            opacity: 0.8;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        
        .page-title {
            text-align: center;
            color: white;
            font-size: 42px;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        .page-subtitle {
            text-align: center;
            color: rgba(255,255,255,0.9);
            font-size: 18px;
            font-weight: 300;
            margin-bottom: 40px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border-radius: 0;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            margin-bottom: 15px;
            border: 1px solid rgba(255,255,255,0.3);
            color: #222;
        }
        
        .card * {
            color: #222;
        }
        
        .card p, .card strong, .card label {
            color: #222;
            font-weight: 600;
        }
        
        .filter-section {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .search-box {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid rgba(224, 224, 224, 0.5);
            border-radius: 0;
            font-size: 16px;
            transition: border 0.2s;
            color: #222;
            font-weight: 500;
        }
        
        .search-box::placeholder {
            color: #666;
            font-weight: 400;
        }
        
        .search-box:focus {
            outline: none;
            border-color: #dc143c;
            box-shadow: 0 0 0 4px rgba(220, 20, 60, 0.2);
            background: rgba(255, 255, 255, 0.7);
        }
        
        .controls {
            display: flex;
            gap: 15px;
        }
        
        
        .btn {
            padding: 12px 24px;
            background: rgba(220, 20, 60, 0.8);
            backdrop-filter: blur(6px);
            color: white;
            border: 1px solid rgba(220, 20, 60, 0.6);
            border-radius: 0;
            cursor: pointer;
            font-size: 15px;
            font-weight: 700;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        
        .btn:hover {
            background: rgba(220, 20, 60, 0.95);
            box-shadow: 0 4px 12px rgba(220, 20, 60, 0.4);
            transform: translateY(-1px);
        }
        
        .btn:active {
            background: rgba(178, 34, 34, 1);
            transform: translateY(0);
        }
        
        /* Unified content area */
        .main-content-area {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .top-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        @media (max-width: 968px) {
            .top-section {
                grid-template-columns: 1fr;
            }
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 0;
        }
        
        .stat-card {
            background: rgba(220, 20, 60, 0.35);
            backdrop-filter: blur(10px);
            color: white;
            padding: 20px;
            border-radius: 0;
            text-align: center;
            box-shadow: none;
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        .stat-card h2 {
            font-size: 48px;
            margin-bottom: 8px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5), 0 0 20px rgba(0,0,0,0.3);
            font-weight: 800;
        }
        
        .stat-card p {
            text-shadow: 0 1px 5px rgba(0,0,0,0.4);
            font-weight: 600;
            font-size: 14px;
        }
        
        .table-container {
            overflow-x: auto;
            max-height: 70vh;
            overflow-y: auto;
            border-radius: 0;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(8px);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td { vertical-align: middle; }
        /* Column alignment */
        thead th:nth-child(1), tbody td:nth-child(1) { text-align: center; }
        thead th:nth-child(3), tbody td:nth-child(3) { text-align: right; }
        thead th:nth-child(4), tbody td:nth-child(4) { text-align: center; }
        thead th:nth-child(5), tbody td:nth-child(5) { text-align: center; }
        /* Use tabular numbers for consistent digit widths */
        .points, .rank, td:nth-child(1) { font-variant-numeric: tabular-nums; }
        
        thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        th {
            background: rgba(248, 249, 250, 0.4);
            backdrop-filter: blur(6px);
            padding: 16px;
            text-align: left;
            font-weight: 700;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: #333;
            text-shadow: 0 1px 3px rgba(255,255,255,0.8);
            border-bottom: 2px solid rgba(224, 224, 224, 0.5);
        }
        
        td {
            padding: 16px;
            border-bottom: 1px solid rgba(240, 240, 240, 0.5);
            font-size: 14px;
            color: #222;
            font-weight: 500;
        }
        
        tbody tr:hover {
            background: rgba(248, 249, 250, 0.5);
            transition: background 0.2s;
        }
        
        .username {
            font-weight: 700;
            color: #dc143c;
            text-shadow: 0 1px 3px rgba(0,0,0,0.2);
            transition: color 0.2s;
            cursor: pointer;
        }
        .username:hover {
            color: #b22222;
            text-decoration: underline;
            text-shadow: 0 1px 5px rgba(220, 20, 60, 0.4);
        }
        
        .twitter-icon {
            color: #000;
            flex-shrink: 0;
        }
        
        .twitter-icon:hover {
            opacity: 1 !important;
            color: #000;
        }
        
        .twitter-icon svg {
            display: block;
        }
        .user-cell { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            cursor: pointer;
            padding: 8px 4px;
        }
        
        .user-cell:hover {
            background: rgba(220, 20, 60, 0.1);
            border-radius: 4px;
        }
        .avatar { 
            width: 32px; 
            height: 32px; 
            border-radius: 50%; 
            flex: 0 0 32px; 
            background: #e9ecef; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 12px; 
            color: #555; 
            border: 1px solid #ddd; 
        }
        .avatar img { 
            width: 100%; 
            height: 100%; 
            border-radius: 50%; 
            display: block; 
        }
        
        .points {
            font-weight: 700;
            color: #000;
            font-size: 16px;
            text-shadow: 0 1px 3px rgba(255,255,255,0.5);
        }
        
        .rank {
            font-weight: 700;
            color: #000;
            text-shadow: 0 1px 3px rgba(255,255,255,0.5);
        }
        
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 0;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge-qualified {
            background: #d4edda;
            color: #155724;
        }
        
        .btn-more {
            width: 100%;
            padding: 14px;
            margin-top: 15px;
            background: #764ba2;
            font-size: 16px;
            border-radius: 0;
        }
        
        .hidden {
            display: none;
        }
        
        .loading {
            text-align: center;
            padding: 60px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .no-results {
            text-align: center;
            padding: 60px;
            color: #999;
        }
        
        .highlight {
            background: rgba(220, 20, 60, 0.2) !important;
            animation: highlight 0.5s ease;
        }
        
        @keyframes highlight {
            0% { background: rgba(220, 20, 60, 0.2); }
            100% { background: rgba(220, 20, 60, 0.2); }
        }
        
        .info-banner {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(8px);
            padding: 14px 20px;
            border-radius: 0;
            margin-bottom: 20px;
            border-left: 3px solid rgba(220, 20, 60, 0.7);
            font-size: 14px;
            color: #000;
        }
        
        .info-banner strong {
            color: #dc143c;
            font-weight: 700;
            text-shadow: 0 1px 3px rgba(255,255,255,0.8);
        }
        .winner-chip {
            background: rgba(220, 20, 60, 0.9);
            backdrop-filter: blur(6px);
            color: #fff;
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
            border: 1px solid rgba(255,255,255,0.2);
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
        }
        .winner-chip:hover {
            background: #5568d3;
            transform: scale(1.05);
        }
        
        /* Calendar Modal */
        .calendar-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 3000;
            overflow-y: auto;
        }
        .calendar-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .calendar-content {
            background: #fff;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
            border-radius: 0;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #dc143c;
        }
        .calendar-header h2 {
            margin: 0;
            color: #000;
            font-size: 28px;
            font-weight: 700;
        }
        .close-calendar {
            background: #dc143c;
            color: #fff;
            border: none;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 0;
            font-weight: 700;
        }
        .close-calendar:hover {
            background: #b22222;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .calendar-day {
            background: rgba(220, 20, 60, 0.05);
            border: 2px solid rgba(220, 20, 60, 0.2);
            padding: 15px;
            border-radius: 0;
            transition: all 0.2s;
        }
        .calendar-day:hover {
            border-color: #dc143c;
            background: rgba(220, 20, 60, 0.1);
            transform: translateY(-2px);
        }
        .calendar-day.has-winner {
            border-color: #dc143c;
            background: rgba(220, 20, 60, 0.15);
        }
        .calendar-date {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
            font-weight: 600;
        }
        .calendar-winner {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }
        .calendar-points {
            font-size: 13px;
            color: #667eea;
        }
        
        /* RNG Terminal Modal */
        .rng-terminal-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            backdrop-filter: blur(4px);
            align-items: center;
            justify-content: center;
        }
        
        .rng-terminal-modal.active {
            display: flex;
        }
        
        .rng-terminal-content {
            background: #1a1a1a;
            border: 2px solid #333;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6), inset 0 0 0 1px rgba(255, 255, 255, 0.1);
            width: 90%;
            max-width: 700px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            font-family: 'Courier New', 'Consolas', monospace;
        }
        
        .rng-terminal-header {
            background: #2d2d2d;
            border-bottom: 1px solid #444;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .rng-terminal-title {
            color: #00ff00;
            font-weight: bold;
            font-size: 14px;
            letter-spacing: 1px;
        }
        
        .rng-terminal-close {
            background: #ff4444;
            border: none;
            color: white;
            width: 24px;
            height: 24px;
            font-size: 14px;
            cursor: pointer;
            line-height: 1;
            padding: 0;
            font-weight: bold;
            transition: background 0.2s;
        }
        
        .rng-terminal-close:hover {
            background: #ff6666;
        }
        
        .rng-terminal-body {
            padding: 16px;
            background: #0a0a0a;
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .rng-terminal-output {
            flex: 1;
            color: #00ff00;
            font-size: 13px;
            line-height: 1.6;
            min-height: 300px;
            margin-bottom: 12px;
        }
        
        .rng-terminal-line {
            margin-bottom: 4px;
            word-wrap: break-word;
        }
        
        .rng-terminal-line.info {
            color: #00ff00;
        }
        
        .rng-terminal-line.success {
            color: #00ff00;
            font-weight: bold;
        }
        
        .rng-terminal-line.data {
            color: #00ffff;
            margin-left: 20px;
        }
        
        .rng-terminal-line.result {
            color: #ffff00;
            font-weight: bold;
            margin-top: 8px;
            border-top: 1px solid #333;
            padding-top: 8px;
        }
        
        .rng-terminal-line.error {
            color: #ff4444;
            font-weight: bold;
        }
        
        .rng-terminal-prompt {
            border-top: 1px solid #333;
            padding-top: 8px;
            display: flex;
            align-items: center;
        }
        
        .rng-prompt {
            color: #00ff00;
            margin-right: 8px;
        }
        
        .rng-cursor {
            color: #00ff00;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        @media (max-width: 768px) {
            .page-title {
                font-size: 32px;
            }
            
            .filter-section {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .stats {
                grid-template-columns: 1fr;
            }
            
            th, td {
                padding: 12px 8px;
                font-size: 13px;
            }
        }
        
        .container-title {
            color: white;
            text-align: center;
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 60px;
            text-shadow: 0 2px 20px rgba(0,0,0,0.3);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Windows XP Style */
        body.xp-mode {
            background: linear-gradient(to bottom, #0054e3 0%, #0054e3 40%, #316ac5 40%, #316ac5 100%);
            background-attachment: fixed;
            font-family: 'Tahoma', 'Verdana', sans-serif;
        }
        
        body.xp-mode .terminal-frame {
            border: 3px outset #c0c0c0;
            background: #ece9d8;
            box-shadow: inset 0 0 0 1px #fff, 0 0 20px rgba(0,0,0,0.3);
            backdrop-filter: none;
        }
        
        body.xp-mode .terminal-topbar {
            background: linear-gradient(to bottom, #0a246a 0%, #a5b4d4 50%, #0a246a 100%);
            border-bottom: 2px inset #0a246a;
            height: 30px;
        }
        
        body.xp-mode .term-dot {
            border: 1px outset #c0c0c0;
            box-shadow: none;
        }
        
        body.xp-mode .term-dot.red { background: #ff0000; }
        body.xp-mode .term-dot.yellow { background: #ffff00; }
        body.xp-mode .term-dot.green { background: #00ff00; }
        
        body.xp-mode .header {
            background: linear-gradient(to bottom, #316ac5 0%, #265eb8 50%, #1e4a9e 100%);
            border-bottom: 2px inset #265eb8;
            padding: 8px 0;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.3);
            backdrop-filter: none;
        }
        
        body.xp-mode .logo {
            color: #fff;
            text-shadow: 1px 1px 0 rgba(0,0,0,0.5);
            font-family: 'Tahoma', sans-serif;
            font-weight: bold;
        }
        
        body.xp-mode .card {
            background: #ece9d8;
            border: 2px inset #ece9d8;
            box-shadow: inset 0 0 0 1px #808080, 0 2px 4px rgba(0,0,0,0.2);
            backdrop-filter: none;
            padding: 12px;
        }
        
        body.xp-mode .stat-card {
            background: linear-gradient(to bottom, #d4d0c8 0%, #ece9d8 50%, #d4d0c8 100%);
            border: 2px outset #ece9d8;
            box-shadow: inset 0 0 0 1px #fff, 0 2px 4px rgba(0,0,0,0.2);
            backdrop-filter: none;
            color: #000;
        }
        
        body.xp-mode .stat-card h2 {
            color: #000080;
            text-shadow: 1px 1px 0 rgba(255,255,255,0.5);
        }
        
        body.xp-mode .stat-card p {
            color: #000;
            text-shadow: none;
        }
        
        body.xp-mode .btn {
            background: linear-gradient(to bottom, #ece9d8 0%, #d4d0c8 50%, #ece9d8 100%);
            border: 2px outset #ece9d8;
            color: #000;
            box-shadow: inset 0 0 0 1px #fff, 0 1px 2px rgba(0,0,0,0.3);
            text-shadow: none;
            font-family: 'Tahoma', sans-serif;
            backdrop-filter: none;
        }
        
        body.xp-mode .btn:hover {
            background: linear-gradient(to bottom, #f4f0e8 0%, #e4e0d8 50%, #f4f0e8 100%);
            transform: none;
        }
        
        body.xp-mode .btn:active {
            border: 2px inset #ece9d8;
            background: linear-gradient(to bottom, #d4d0c8 0%, #ece9d8 50%, #d4d0c8 100%);
            transform: none;
        }
        
        body.xp-mode .search-box {
            background: #fff;
            border: 2px inset #ece9d8;
            color: #000;
            font-family: 'Tahoma', sans-serif;
            backdrop-filter: none;
        }
        
        body.xp-mode .search-box:focus {
            border: 2px inset #4a90e2;
            box-shadow: inset 0 0 0 1px #316ac5;
            background: #fff;
        }
        
        body.xp-mode .table-container {
            background: #fff;
            border: 2px inset #ece9d8;
            backdrop-filter: none;
        }
        
        body.xp-mode th {
            background: linear-gradient(to bottom, #316ac5 0%, #265eb8 100%);
            color: #fff;
            border: 1px inset #265eb8;
            text-shadow: 1px 1px 0 rgba(0,0,0,0.5);
            backdrop-filter: none;
        }
        
        body.xp-mode td {
            background: #fff;
            border-bottom: 1px solid #d4d0c8;
            color: #000;
        }
        
        body.xp-mode tbody tr:hover {
            background: #e8f4f8;
        }
        
        body.xp-mode .info-banner {
            background: #fffacd;
            border: 2px inset #fffacd;
            backdrop-filter: none;
            border-left: 4px solid #ffd700;
        }
        
        body.xp-mode .info-banner strong {
            color: #000080;
            text-shadow: none;
        }
        
        body.xp-mode .winner-chip {
            background: linear-gradient(to bottom, #316ac5 0%, #265eb8 100%);
            border: 2px outset #316ac5;
            color: #fff;
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.3), 0 1px 2px rgba(0,0,0,0.3);
        }
        
        body.xp-mode select {
            background: linear-gradient(to bottom, #ece9d8 0%, #d4d0c8 100%);
            border: 2px outset #ece9d8;
            color: #000;
            font-family: 'Tahoma', sans-serif;
            backdrop-filter: none;
        }
        
        body.xp-mode .snow-container {
            display: none;
        }
    </style>
</head>
<body>
    <div class="terminal-frame">
        <div class="terminal-topbar">
            <div class="term-dot red" id="btnClose" title="Close"></div>
            <div class="term-dot yellow" id="btnMin" title="Minimize"></div>
            <div class="term-dot green" id="btnZoom" title="Zoom"></div>
        </div>
        <div class="terminal-inner">
            <div class="header">
                <div class="header-content">
                    <div class="logo">pointslotto powered by <a href="https://www.pointsmarket.io/" target="_blank" style="color: #fff; text-decoration: underline;">@pointsmarket.io</a></div>
                    <div style="display:flex; align-items:center; gap:12px;">
                        <!-- Daily Winner Display in Header -->
                        <div id="winnerCardHeader" class="winner-chip" style="display:none; padding: 8px 14px; font-size: 13px; cursor: pointer;" onclick="showCalendar()" title="Click to view all winners">
                            üèÜ Daily Winner: <span id="chipUser">-</span> ¬∑ <span id="chipPts">0</span> pts
                        </div>
                        <div style="color: #333; font-size: 14px; font-weight: 600; text-shadow: 0 1px 2px rgba(255,255,255,0.6);">Last Updated: <span id="lastUpdate">{{ "Just now" }}</span></div>
                    </div>
                </div>
            </div>
            
            <!-- Snow Animation -->
            <div class="snow-container" id="snowContainer"></div>
            
            <!-- Calendar Modal -->
            <div id="calendarModal" class="calendar-modal">
                <div class="calendar-content">
                    <div class="calendar-header">
                        <h2>üìÖ Winners Calendar</h2>
                        <button class="close-calendar" onclick="closeCalendar()">‚úï Close</button>
                    </div>
                    <div id="calendarGrid" class="calendar-grid">
                        <div style="text-align: center; padding: 40px; color: #999;">
                            <div class="spinner"></div>
                            <p style="margin-top: 15px;">Loading winners...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- RNG Terminal Modal -->
            <div id="rngTerminalModal" class="rng-terminal-modal">
                <div class="rng-terminal-content">
                    <div class="rng-terminal-header">
                        <div class="rng-terminal-title">üé≤ RANDOM SELECTION PROCESS</div>
                        <button class="rng-terminal-close" onclick="closeRngTerminal()">‚úï</button>
                    </div>
                    <div class="rng-terminal-body">
                        <div id="rngTerminalOutput" class="rng-terminal-output">
                            <div class="rng-terminal-line">$ Initializing random number generator...</div>
                        </div>
                        <div class="rng-terminal-prompt">
                            <span class="rng-prompt">points-lotto@selection:</span>
                            <span class="rng-cursor">‚ñà</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="container">
        <!-- Unified content area -->
        <div class="main-content-area">
            <!-- Top section: Stats and Controls -->
            <div class="top-section">
                <!-- Stats cards -->
                <div class="stats">
                    <div class="stat-card">
                        <h2 id="totalUsers">{{ total }}</h2>
                        <p id="totalUsersLabel">Qualified Users</p>
                    </div>
                    <div class="stat-card" style="background: rgba(178, 34, 34, 0.35); backdrop-filter: blur(10px);" id="countdownCard">
                        <h2 id="countdownTime">00:00:00</h2>
                        <p id="countdownLabel">Until Reset</p>
                        <p id="periodSubtitle" style="font-size: 11px; opacity: 0.8; margin-top: 8px;">Drawing Every 24hrs</p>
                    </div>
                </div>
                
                <!-- Controls - improved styling -->
                <div class="card">
                    <div style="display: flex; gap: 15px; align-items: center; justify-content: space-between;">
                        <div style="flex: 1;">
                            <select id="viewSelect" onchange="onViewChange()" style="padding: 10px 16px; border: 1px solid rgba(224, 224, 224, 0.6); border-radius: 0; font-size: 15px; font-weight: 700; color: #222; background: rgba(255, 255, 255, 0.5); backdrop-filter: blur(4px); cursor: pointer; min-width: 140px; text-shadow: 0 1px 2px rgba(255,255,255,0.6);">
                                <option value="min1">Qualified</option>
                                <option value="gain24">Total Points</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn" onclick="checkQualification()" style="padding: 10px 20px; font-size: 14px;">Check Status</button>
                            <button class="btn" onclick="loadQualifiedUsers()" style="padding: 10px 20px; font-size: 14px;">Refresh</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Search bar on left -->
            <div class="card">
                <input type="text" 
                       class="search-box" 
                       id="searchBox" 
                       placeholder="Search username ‚Äî Press Enter to check qualification" 
                       onkeyup="onSearchKey(event)"
                       style="width: 100%; margin: 0; background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(6px);">
                <div id="qualificationResult" style="display: none; padding: 12px; margin-top: 12px; border-radius: 0; font-size: 14px; background: rgba(220, 20, 60, 0.25); backdrop-filter: blur(8px); border: 1px solid rgba(220, 20, 60, 0.5); color: #222; font-weight: 500;"></div>
                <div style="margin-top: 12px; display: flex; justify-content: center;">
                    <button class="btn" onclick="showWinnerRngProcess()" style="padding: 10px 20px; font-size: 14px; background: rgba(0, 150, 0, 0.3); border-color: rgba(0, 150, 0, 0.5);">
                        üé≤ View Winner Selection
                    </button>
                </div>
            </div>
            </div>
            
            <!-- Info banner -->
            <div class="info-banner" id="infoBanner">
                <strong>Qualified:</strong> Only showing users who gained 1+ points in the last 24 hours. Search for your Twitter username to find your rank and points! Don't be afraid - only 1 ticket per user.
            </div>
        </div>
        
        <!-- Table container -->
        <div class="card">
            <div class="table-container" id="tableContainer">
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p style="color: #999; font-size: 16px; margin-top: 15px;">Loading qualified users...</p>
                </div>
            </div>
            
            <button class="btn btn-more hidden" id="showMoreBtn" onclick="showAllUsers()">
                Show All Users (Loading...)
            </button>
        </div>
            </div>
        </div>
    </div>
    
    <button id="restoreWindowBtn">Open Window</button>
    
    <script>
        let currentData = {{ qualified_users | tojson }};
        let allUsers = [];
        let displayedCount = 100;
        let currentLimit = 100;
        let searchTerm = '';
        let currentView = '{{ view|default("min1") }}';
        let nextResetTime;
        let countdownInterval = null;
        let autoRefreshInterval = null;
        
        // Initialize reset time
        try {
            nextResetTime = new Date('{{ next_reset_iso|default("") }}');
            if (isNaN(nextResetTime.getTime())) {
                // Calculate next midnight if not provided
                const now = new Date();
                nextResetTime = new Date(now);
                nextResetTime.setDate(nextResetTime.getDate() + 1);
                nextResetTime.setHours(0, 0, 0, 0);
            }
        } catch(e) {
            // Calculate next midnight as fallback
            const now = new Date();
            nextResetTime = new Date(now);
            nextResetTime.setDate(nextResetTime.getDate() + 1);
            nextResetTime.setHours(0, 0, 0, 0);
        }
        
        function fillSearchBar(username) {
            // Remove @ if present
            const cleanUsername = username.replace(/^@/, '');
            const searchBox = document.getElementById('searchBox');
            if (searchBox) {
                searchBox.value = cleanUsername;
                // Trigger search automatically
                searchTerm = cleanUsername.toLowerCase();
                displayUsers(allUsers, currentLimit);
                // Also scroll to show the result
                setTimeout(() => {
                    const userCell = Array.from(document.querySelectorAll('.username')).find(el => el.textContent.toLowerCase().includes(cleanUsername.toLowerCase()));
                    if (userCell) {
                        userCell.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 100);
            }
        }
        
        function checkQualification() {
            const input = document.getElementById('searchBox');
            const resultDiv = document.getElementById('qualificationResult');
            const username = input.value.trim().toLowerCase().replace('@', '');
            
            if (!username) {
                resultDiv.style.display = 'block';
                resultDiv.style.background = 'rgba(255, 152, 0, 0.1)';
                resultDiv.style.border = '1px solid rgba(255, 152, 0, 0.3)';
                resultDiv.innerHTML = '‚ö†Ô∏è Please enter a Twitter username';
                return;
            }
            
            // Show loading
            resultDiv.style.display = 'block';
            resultDiv.style.background = 'rgba(102, 126, 234, 0.1)';
            resultDiv.style.border = '1px solid rgba(102, 126, 234, 0.3)';
            resultDiv.innerHTML = 'üîÑ Checking qualification status...';
            
            fetch(`/api/check_qualification/${username}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        resultDiv.style.background = 'rgba(244, 67, 54, 0.1)';
                        resultDiv.style.border = '1px solid rgba(244, 67, 54, 0.3)';
                        resultDiv.innerHTML = `‚ùå Error: ${data.error}`;
                        return;
                    }
                    
                    if (!data.found) {
                        resultDiv.style.background = 'rgba(244, 67, 54, 0.1)';
                        resultDiv.style.border = '1px solid rgba(244, 67, 54, 0.3)';
                        resultDiv.innerHTML = `‚ùå <strong>@${username}</strong> not found in leaderboard`;
                        return;
                    }
                    
                    if (data.qualifies) {
                        resultDiv.style.background = 'rgba(76, 175, 80, 0.15)';
                        resultDiv.style.border = '2px solid rgba(76, 175, 80, 0.5)';
                        resultDiv.innerHTML = `
                            <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px; color: #4caf50;">
                                ${data.reason}
                            </div>
                            <div style="display: flex; gap: 20px; margin-top: 10px; font-size: 13px; opacity: 0.8;">
                                <span>üìä Total Points: <strong>${data.total_points}</strong></span>
                                ${data.gained_in_24h > 0 ? `<span>üìà Gained in 24h: <strong>+${data.gained_in_24h}</strong></span>` : ''}
                                ${data.rank > 0 ? `<span>üèÜ Rank: <strong>#${data.rank}</strong></span>` : ''}
                            </div>
                            <div style="margin-top: 12px; padding: 8px; background: rgba(102, 126, 234, 0.1); font-size: 12px; opacity: 0.8;">
                                üí° You're in the drawing! Check back at midnight to see if you won.
                            </div>
                        `;
                        
                        // Highlight their row in the table if they're visible
                        setTimeout(() => {
                            const rows = document.querySelectorAll('#usersTable tbody tr');
                            rows.forEach(row => {
                                const usernameCell = row.querySelector('td');
                                if (usernameCell && usernameCell.textContent.toLowerCase().includes(username)) {
                                    row.classList.add('highlight');
                                    row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                    setTimeout(() => row.classList.remove('highlight'), 3000);
                                }
                            });
                        }, 500);
                    } else {
                        resultDiv.style.background = 'rgba(244, 67, 54, 0.1)';
                        resultDiv.style.border = '1px solid rgba(244, 67, 54, 0.3)';
                        resultDiv.innerHTML = `
                            <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px; color: #f44336;">
                                ${data.reason}
                            </div>
                            <div style="display: flex; gap: 20px; margin-top: 10px; font-size: 13px; opacity: 0.8;">
                                <span>üìä Total Points: <strong>${data.total_points}</strong></span>
                                ${data.gained_in_24h > 0 ? `<span>üìà Gained in 24h: <strong>+${data.gained_in_24h}</strong></span>` : '<span>üìà Gained in 24h: <strong>0</strong></span>'}
                            </div>
                            <div style="margin-top: 12px; padding: 8px; background: rgba(255, 152, 0, 0.1); font-size: 12px; opacity: 0.8;">
                                üí° To qualify: You need ‚â•1 total points AND +1 point gained in the last 24 hours
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    resultDiv.style.background = 'rgba(244, 67, 54, 0.1)';
                    resultDiv.style.border = '1px solid rgba(244, 67, 54, 0.3)';
                    resultDiv.innerHTML = `‚ùå Error checking qualification: ${error.message}`;
                });
        }
        
        function onSearchKey(e) {
            searchUsers();
            if (e.key === 'Enter') {
                checkQualification();
            }
        }
        
        function showCalendar() {
            const modal = document.getElementById('calendarModal');
            const grid = document.getElementById('calendarGrid');
            
            modal.classList.add('active');
            
            // Show loading
            grid.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;"><div class="spinner"></div><p style="margin-top: 15px;">Loading winners...</p></div>';
            
            // Fetch all winners
            fetch('/api/all_winners')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.winners && data.winners.length > 0) {
                        // Group winners by month for better organization
                        const winnersByMonth = {};
                        data.winners.forEach(winner => {
                            const date = new Date(winner.drawing_date + 'T00:00:00');
                            const monthKey = date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
                            if (!winnersByMonth[monthKey]) {
                                winnersByMonth[monthKey] = [];
                            }
                            winnersByMonth[monthKey].push(winner);
                        });
                        
                        // Build calendar display
                        let html = '';
                        Object.keys(winnersByMonth).sort().reverse().forEach(month => {
                            html += `<div style="grid-column: 1 / -1; font-size: 20px; font-weight: 600; color: #dc143c; margin: 20px 0 10px 0; padding-bottom: 10px; border-bottom: 1px solid rgba(220, 20, 60, 0.2);">${month}</div>`;
                            winnersByMonth[month].forEach(winner => {
                                const date = new Date(winner.drawing_date + 'T00:00:00');
                                const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                                html += `
                                    <div class="calendar-day has-winner">
                                        <div class="calendar-date">${dateStr}</div>
                                        <div class="calendar-winner">@${winner.username}</div>
                                        <div class="calendar-points">${winner.points} points</div>
                                        ${winner.total_eligible ? `<div style="font-size: 11px; color: #999; margin-top: 4px;">From ${winner.total_eligible} eligible</div>` : ''}
                                    </div>
                                `;
                            });
                        });
                        
                        grid.innerHTML = html;
                    } else {
                        grid.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;"><p>No winners yet. Check back after the first drawing!</p></div>';
                    }
                })
                .catch(error => {
                    grid.innerHTML = `<div style="text-align: center; padding: 40px; color: #f44336;"><p>Error loading winners: ${error.message}</p></div>`;
                });
        }
        
        function closeCalendar() {
            const modal = document.getElementById('calendarModal');
            modal.classList.remove('active');
        }
        
        // Close modal when clicking outside
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('calendarModal');
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeCalendar();
                }
            });
            
            // Close on Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && modal.classList.contains('active')) {
                    closeCalendar();
                }
            });
        });
        
        function searchUsers() {
            searchTerm = document.getElementById('searchBox').value.toLowerCase();
            displayUsers(allUsers, currentLimit);
        }
        
        function displayUsers(users, limit = 100) {
            allUsers = users;
            currentLimit = limit;
            const container = document.getElementById('tableContainer');
            
            // Apply search filter
            let filteredUsers = users;
            if (searchTerm) {
                filteredUsers = users.filter(user => {
                    const username = (user.username || '').toLowerCase();
                    return username.includes(searchTerm);
                });
            }
            
            if (filteredUsers.length === 0) {
                container.innerHTML = '<div class="no-results"><h3>No matches found</h3><p>Try a different search term.</p></div>';
                return;
            }
            
            const usersToDisplay = limit ? filteredUsers.slice(0, limit) : filteredUsers;
            displayedCount = usersToDisplay.length;
            
            const showGain = currentView === 'gain24';
            let html = '<table>' +
                '<colgroup>' +
                  '<col style="width: 56px;">' +
                  '<col style="width: auto;">' +
                  '<col style="width: 160px;">' +
                  (showGain ? '<col style="width: 160px;">' : '') +
                  '<col style="width: 110px;">' +
                  '<col style="width: 140px;">' +
                '</colgroup>' +
                '<thead><tr><th>#</th><th>User</th><th>Total Points</th>' + (showGain ? '<th>Gained (24h)</th>' : '') + '<th>Rank</th><th>Status</th></tr></thead><tbody>';
            
            usersToDisplay.forEach((user, index) => {
                const username = user.username || 'N/A';
                const points = user.total_points || 0;
                const rank = user.rank || index + 1;
                const gain = user.gain || 0;
                const highlightClass = searchTerm && username.toLowerCase().includes(searchTerm) ? 'highlight' : '';
                
                const avatarUrl = username ? `https://unavatar.io/twitter/${username}` : '';
                const initials = (username || 'NA').slice(0,2).toUpperCase();
                const avatarHTML = username ? `
                    <span class="avatar"><img src="${avatarUrl}" alt="@${username}" onerror="this.onerror=null;this.parentNode.textContent='${initials}';this.remove();" /></span>
                ` : `<span class="avatar">${initials}</span>`;
                html += `
                    <tr class="${highlightClass}">
                        <td><strong>${index + 1}</strong></td>
                        <td class="user-cell" onclick="fillSearchBar('${username}');" style="cursor: pointer;">
                            ${avatarHTML}
                            <a href="#" class="username" style="text-decoration: none; color: inherit; cursor: pointer;" onclick="event.stopPropagation(); fillSearchBar('${username}'); return false;">@${username}</a>
                            <a href="https://twitter.com/${username}" target="_blank" rel="noopener noreferrer" class="twitter-icon" title="View on X (Twitter)" onclick="event.stopPropagation();" style="margin-left: 6px; display: inline-flex; align-items: center; justify-content: center; opacity: 0.7; transition: opacity 0.2s; width: 18px; height: 18px;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle;">
                                    <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                                </svg>
                            </a>
                        </td>
                        <td class="points">${points}</td>
                        ${showGain ? `<td style=\"color: #28a745; font-weight: 600;\">+${gain}</td>` : ''}
                        <td class="rank">#${rank}</td>
                        <td><span class="badge badge-qualified">‚úì Qualifies</span></td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
            
            // Update stats
            if (searchTerm) {
                document.getElementById('totalUsers').textContent = filteredUsers.length;
            } else {
                document.getElementById('totalUsers').textContent = users.length;
            }
            
            // Show "Show All" button
            if (filteredUsers.length > limit && !searchTerm) {
                document.getElementById('showMoreBtn').classList.remove('hidden');
                document.getElementById('showMoreBtn').textContent = `Show All ${filteredUsers.length} Users`;
            } else {
                document.getElementById('showMoreBtn').classList.add('hidden');
            }
        }
        
        function showAllUsers() {
            displayUsers(allUsers, null);
        }
        
        function loadQualifiedUsers() {
            const container = document.getElementById('tableContainer');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p style="color: #999; font-size: 16px; margin-top: 15px;">Loading active users...</p></div>';
            
            const view = currentView || 'min1';
            const url = `/api/qualified?view=${encodeURIComponent(view)}`;
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Preserve search term and reapply
                        allUsers = data.qualified_users;
                        displayUsers(allUsers, 100);
                        document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
                        // Update labels and counts
                        document.getElementById('totalUsers').textContent = data.total;
                        document.getElementById('totalUsersLabel').textContent = (view === 'gain24') ? 'Qualified Users' : 'Qualified Users';
                        // Period subtitle stays under timer now
                        if (view === 'gain24') {
                            document.getElementById('infoBanner').innerHTML = '<strong>Total Points</strong>';
                        } else {
                            document.getElementById('infoBanner').innerHTML = '<strong>Qualified:</strong> Only showing users who gained 1+ points in the last 24 hours. Search for your Twitter username to find your rank and points! Don\'t be afraid - only 1 ticket per user.';
                        }
                        updateCountdownVisibility();
                    } else {
                        container.innerHTML = '<div class="no-results"><h3>Error</h3><p>' + (data.error || 'Unknown error') + '</p></div>';
                    }
                })
                .catch(error => {
                    container.innerHTML = '<div class="no-results"><h3>Error</h3><p>' + error.message + '</p></div>';
                });
        }

        function onViewChange() {
            const select = document.getElementById('viewSelect');
            currentView = select.value;
            loadQualifiedUsers();
            updateCountdownVisibility();
        }
        
        function updateCountdown() {
            const now = new Date();
            const diff = nextResetTime - now;
            
            if (diff <= 0) {
                // Timer reached zero - scheduler should select winner soon
                // Poll more aggressively to catch new winner (scheduler runs at 00:01-00:05)
                loadCurrentWinner(false); // First check, don't show terminal yet
                
                // Reset happened, recalculate for next midnight
                nextResetTime = new Date(now);
                nextResetTime.setDate(nextResetTime.getDate() + 1);
                nextResetTime.setHours(0, 0, 0, 0);
                
                // Poll every 5 seconds for next 2 minutes to catch winner selection
                let pollCount = 0;
                const maxPolls = 24; // 24 polls * 5 seconds = 2 minutes
                const aggressivePoll = setInterval(() => {
                    pollCount++;
                    // Only show terminal on new winner detection after first poll
                    loadCurrentWinner(pollCount > 1);
                    if (pollCount >= maxPolls) {
                        clearInterval(aggressivePoll);
                    }
                }, 5000); // Every 5 seconds
                
                updateCountdown();
                return;
            }
            
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            
            const timeString = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            
            const countdownElement = document.getElementById('countdownTime');
            if (countdownElement) {
                countdownElement.textContent = timeString;
            }
        }
        
        function updateCountdownVisibility() {
            const countdownCard = document.getElementById('countdownCard');
            if (!countdownCard) return;
            // Always show the timer (applies to both views)
            countdownCard.style.display = 'block';
            if (!countdownInterval) {
                updateCountdown();
                countdownInterval = setInterval(updateCountdown, 1000);
            }
        }
        
        function showRngTerminal() {
            const modal = document.getElementById('rngTerminalModal');
            const output = document.getElementById('rngTerminalOutput');
            if (modal && output) {
                output.innerHTML = '<div class="rng-terminal-line info">$ Initializing random number generator...</div>';
                modal.classList.add('active');
            }
        }
        
        function closeRngTerminal() {
            const modal = document.getElementById('rngTerminalModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }
        
        function showWinnerRngProcess() {
            // Show terminal
            showRngTerminal();
            
            // Clear and start
            const output = document.getElementById('rngTerminalOutput');
            if (output) {
                output.innerHTML = '<div class="rng-terminal-line info">$ Loading winner selection details...</div>';
            }
            
            // Fetch current winner with RNG info
            fetch('/api/current_winner')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.winner) {
                        // Simulate the RNG process with actual data
                        setTimeout(() => {
                            addTerminalLine('$ Winner Selection Process', 'success');
                            addTerminalLine(`$ Drawing Date: ${data.winner.drawing_date || 'N/A'}`, 'info');
                            addTerminalLine('');
                            
                            addTerminalLine('$ Step 1: Fetching fresh leaderboard data...', 'info');
                            setTimeout(() => addTerminalLine('  ‚úÖ Data fetched from PointsMarket.io', 'success'), 500);
                            
                            setTimeout(() => {
                                addTerminalLine('');
                                addTerminalLine('$ Step 2: Filtering qualified users...', 'info');
                                if (data.total_eligible) {
                                    addTerminalLine(`  ‚úÖ Found ${data.total_eligible} qualified users`, 'data');
                                    addTerminalLine('  (Users with ‚â•1 total points who gained +1 in last 24h)', 'data');
                                }
                            }, 1000);
                            
                            setTimeout(() => {
                                addTerminalLine('');
                                addTerminalLine('$ Step 3: Generating random seed...', 'info');
                                if (data.random_seed) {
                                    addTerminalLine(`  Seed: ${data.random_seed}`, 'data');
                                    addTerminalLine('  Method: SHA256 hash of (date + timestamp + qualified_count)', 'data');
                                }
                            }, 1500);
                            
                            setTimeout(() => {
                                addTerminalLine('');
                                addTerminalLine('$ Step 4: Applying seed to random number generator...', 'info');
                                setTimeout(() => addTerminalLine('  ‚úÖ RNG seeded and ready', 'success'), 400);
                            }, 2000);
                            
                            setTimeout(() => {
                                addTerminalLine('');
                                addTerminalLine('$ Step 5: Random selection in progress...', 'info');
                                setTimeout(() => addTerminalLine('  ‚úÖ Selection complete!', 'success'), 600);
                            }, 2500);
                            
                            setTimeout(() => {
                                addTerminalLine('');
                                addTerminalLine('', 'result');
                                addTerminalLine('üèÜ WINNER SELECTED:', 'result');
                                addTerminalLine(`   Username: @${data.winner.username}`, 'result');
                                addTerminalLine(`   Points: ${data.winner.points}`, 'result');
                                if (data.total_eligible) {
                                    addTerminalLine(`   Selected from: ${data.total_eligible} eligible users`, 'result');
                                }
                                if (data.random_seed) {
                                    addTerminalLine(`   Random Seed: ${data.random_seed}`, 'result');
                                }
                                if (data.selection_hash) {
                                    addTerminalLine(`   Verification Hash: ${data.selection_hash}`, 'result');
                                }
                                if (data.winner.drawing_date) {
                                    addTerminalLine(`   Drawing Date: ${data.winner.drawing_date}`, 'result');
                                }
                                if (data.winner.selected_at) {
                                    addTerminalLine(`   Selected At: ${data.winner.selected_at}`, 'result');
                                }
                            }, 3000);
                        }, 300);
                    } else {
                        addTerminalLine('$ No winner has been selected yet', 'error');
                        addTerminalLine('$ A winner will be selected at midnight (00:00)', 'info');
                    }
                })
                .catch(error => {
                    addTerminalLine(`$ Error loading winner details: ${error.message}`, 'error');
                    console.error('Error loading winner:', error);
                });
        }
        
        function addTerminalLine(text, className = 'info') {
            const output = document.getElementById('rngTerminalOutput');
            if (output) {
                const line = document.createElement('div');
                line.className = 'rng-terminal-line ' + className;
                line.textContent = text;
                output.appendChild(line);
                output.scrollTop = output.scrollHeight;
            }
        }
        
        function selectNewWinner() {
            // Show terminal
            showRngTerminal();
            
            // Animate terminal output
            setTimeout(() => addTerminalLine('$ Fetching fresh leaderboard data...', 'info'), 300);
            setTimeout(() => addTerminalLine('$ Loading qualified users...', 'info'), 800);
            
            // Always select from users who qualify AND gained +1 point in last 24h
            fetch('/api/select_winner', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({})  // No view parameter needed - always uses 24h gains logic
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show RNG details
                    setTimeout(() => {
                        addTerminalLine(`$ Found ${data.total_eligible} qualified users`, 'success');
                        addTerminalLine(`$ Generating random seed...`, 'info');
                        
                        setTimeout(() => {
                            if (data.seed_string) {
                                const seedDisplay = data.seed_string.substring(0, 50) + '...';
                                addTerminalLine(`  Seed input: ${seedDisplay}`, 'data');
                            }
                        }, 400);
                        
                        setTimeout(() => {
                            if (data.random_seed) {
                                addTerminalLine(`  Random seed: ${data.random_seed}`, 'data');
                                addTerminalLine(`$ Applying seed to RNG...`, 'info');
                            }
                        }, 800);
                        
                        setTimeout(() => {
                            addTerminalLine(`$ Selecting from ${data.total_eligible} eligible users...`, 'info');
                            addTerminalLine(`$ Random selection complete!`, 'success');
                        }, 1200);
                        
                        setTimeout(() => {
                            if (data.winner) {
                                addTerminalLine('', 'result');
                                addTerminalLine(`üèÜ WINNER SELECTED: @${data.winner.username}`, 'result');
                                addTerminalLine(`   Points: ${data.winner.points}`, 'result');
                                if (data.winner_index) {
                                    addTerminalLine(`   Position: #${data.winner_index} of ${data.total_eligible}`, 'result');
                                }
                                if (data.random_seed) {
                                    addTerminalLine(`   Seed: ${data.random_seed}`, 'result');
                                }
                                if (data.selection_hash) {
                                    addTerminalLine(`   Hash: ${data.selection_hash}`, 'result');
                                }
                            }
                        }, 1600);
                        
                        setTimeout(() => {
                            displayWinner(data.winner, false); // Don't show terminal again, already showing
                            // Auto-close after 5 seconds
                            setTimeout(() => {
                                closeRngTerminal();
                            }, 5000);
                        }, 2000);
                    }, 1200);
                } else {
                    addTerminalLine(`$ Error: ${data.error || 'Selection failed'}`, 'error');
                }
            })
            .catch(error => {
                addTerminalLine(`$ Error: ${error.message}`, 'error');
                console.error('Error selecting winner:', error);
            });
        }
        
        let lastDisplayedWinner = null; // Track last winner to detect new ones
        
        function loadCurrentWinner(showTerminalIfNew = false) {
            fetch('/api/current_winner')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.winner) {
                        const currentWinner = data.winner.username + '_' + (data.winner.drawing_date || 'unknown');
                        
                        // Detect if this is a new winner (different from last displayed)
                        const isNewWinner = lastDisplayedWinner !== null && lastDisplayedWinner !== currentWinner;
                        
                        if (isNewWinner && showTerminalIfNew) {
                            // New winner detected - show terminal automatically
                            displayWinner(data.winner, true);
                        } else {
                            displayWinner(data.winner, false);
                        }
                        
                        lastDisplayedWinner = currentWinner;
                    }
                    // No winner yet - wait for timer to reach zero (midnight) for first selection
                    // The scheduler will automatically select a winner at midnight
                })
                .catch(error => {
                    console.error('Error loading winner:', error);
                });
        }
        
        function displayWinner(winner, showTerminalAutomatically = false) {
            // Update header display (primary location)
            const headerCard = document.getElementById('winnerCardHeader');
            const cu = document.getElementById('chipUser');
            const cp = document.getElementById('chipPts');
            if (headerCard && cu && cp) {
                cu.textContent = '@' + winner.username;
                cp.textContent = winner.points || 0;
                headerCard.style.display = 'inline-flex';
            }
            
            // Optionally show terminal automatically when new winner is detected
            if (showTerminalAutomatically) {
                setTimeout(() => {
                    showWinnerRngProcess();
                }, 1000); // Show terminal 1 second after winner is displayed
            }
        }
        
        function createSnow() {
            const snowContainer = document.getElementById('snowContainer');
            if (!snowContainer) {
                console.error('Snow container not found');
                return;
            }
            
            const snowflakes = ['‚ùÑ', '‚ùÖ', '‚ùÜ'];
            const numFlakes = 15; // Reduced from 50 for subtlety
            
            // Create initial snowflakes (subtle, slower)
            for (let i = 0; i < numFlakes; i++) {
                setTimeout(() => {
                    const flake = document.createElement('div');
                    flake.className = 'snowflake';
                    flake.textContent = snowflakes[Math.floor(Math.random() * snowflakes.length)];
                    flake.style.left = Math.random() * 100 + '%';
                    // Slower animation (8-12 seconds instead of 5-8)
                    flake.style.animationDuration = (Math.random() * 4 + 8) + 's';
                    flake.style.animationDelay = Math.random() * 3 + 's';
                    // Lower opacity (0.15-0.4 instead of 0.3-1.0)
                    flake.style.opacity = Math.random() * 0.25 + 0.15;
                    // Smaller size (8-14px instead of 15-30px)
                    flake.style.fontSize = (Math.random() * 6 + 8) + 'px';
                    snowContainer.appendChild(flake);
                    
                    // Remove flake after animation
                    setTimeout(() => {
                        if (flake.parentNode) {
                            flake.parentNode.removeChild(flake);
                        }
                    }, 15000);
                }, i * 300);
            }
            
            // Continuously add new snowflakes (less frequently)
            setInterval(() => {
                if (!snowContainer) return;
                const flake = document.createElement('div');
                flake.className = 'snowflake';
                flake.textContent = snowflakes[Math.floor(Math.random() * snowflakes.length)];
                flake.style.left = Math.random() * 100 + '%';
                // Slower animation
                flake.style.animationDuration = (Math.random() * 4 + 8) + 's';
                // Lower opacity
                flake.style.opacity = Math.random() * 0.25 + 0.15;
                // Smaller size
                flake.style.fontSize = (Math.random() * 6 + 8) + 'px';
                snowContainer.appendChild(flake);
                
                setTimeout(() => {
                    if (flake.parentNode) {
                        flake.parentNode.removeChild(flake);
                    }
                }, 15000);
            }, 2000); // Every 2 seconds instead of 0.5 seconds for subtlety
        }
        
        function attachWindowControls() {
            const frame = document.querySelector('.terminal-frame');
            const btnClose = document.getElementById('btnClose');
            const btnMin = document.getElementById('btnMin');
            const btnZoom = document.getElementById('btnZoom');
            const restoreBtn = document.getElementById('restoreWindowBtn');

            if (btnClose) {
                btnClose.onclick = function() {
                    frame.classList.add('hidden');
                    document.body.classList.add('bg-bright');
                    restoreBtn.style.display = 'block';
                };
            }
            if (restoreBtn) {
                restoreBtn.onclick = function() {
                    frame.classList.remove('hidden');
                    restoreBtn.style.display = 'none';
                };
            }
            if (btnMin) {
                btnMin.onclick = function() {
                    frame.classList.toggle('collapsed');
                };
            }
            if (btnZoom) {
                btnZoom.onclick = function() {
                    document.body.classList.toggle('xp-mode');
                    // Store XP mode preference
                    if (document.body.classList.contains('xp-mode')) {
                        localStorage.setItem('xp-mode', 'true');
                    } else {
                        localStorage.setItem('xp-mode', 'false');
                    }
                };
            }
        }

        window.onload = function() {
            // Check for saved XP mode preference
            if (localStorage.getItem('xp-mode') === 'true') {
                document.body.classList.add('xp-mode');
            }
            
            // Initialize view selector
            const select = document.getElementById('viewSelect');
            if (select) {
                if (currentView === 'gain24') select.value = 'gain24';
                else select.value = 'min1'; // Default to Qualified
            }

            displayUsers(currentData);
            const lastUpdateEl = document.getElementById('lastUpdate');
            if (lastUpdateEl) {
                lastUpdateEl.textContent = new Date().toLocaleTimeString();
            }
            
            // Create snow animation immediately
            createSnow();
            
            // Start countdown if in gain24 view
            updateCountdownVisibility();
            
            // Load current winner on page load
            loadCurrentWinner();
            
            // Auto-refresh qualified users count every 5 minutes
            autoRefreshInterval = setInterval(() => {
                loadQualifiedUsers();
            }, 5 * 60 * 1000); // 5 minutes
            
            // Check for new winner periodically (especially after midnight)
            // Check every 30 seconds to catch new winners selected by scheduler
            setInterval(() => {
                loadCurrentWinner();
            }, 30 * 1000); // 30 seconds
            
            // Show baseline message if applicable
            {% if is_baseline %}
            document.getElementById('infoBanner').innerHTML = '<strong>üìä Baseline Created:</strong> Today is the first day of tracking. After 24 hours, only users who gained 1+ points will be shown. Currently showing all users for initial setup.';
            {% endif %}
            
            // Update gain display for baseline users
            {% if is_baseline %}
            setTimeout(function() {
                const rows = document.querySelectorAll('#tableContainer table tbody tr');
                rows.forEach(row => {
                    const gainCell = row.children[3];
                    if (gainCell && gainCell.textContent === '+0') {
                        gainCell.textContent = 'Baseline';
                        gainCell.style.color = '#999';
                    }
                });
            }, 100);
            {% endif %}

            // Window controls
            attachWindowControls();
        };
    </script>
</body>
</html>
